<!DOCTYPE html>
<html lang="{{ lang }}" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.title }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ config.description }}{% endblock %}">

    <!-- Prevent FOUC (Flash of Unstyled Content) -->
    <style>
        html.no-js { visibility: hidden; opacity: 0; }
        html.js { visibility: visible; opacity: 1; transition: opacity 0.2s ease-in; }
    </style>
    <script>document.documentElement.classList.remove('no-js');document.documentElement.classList.add('js');</script>

    <!-- SEO Meta Tags -->
    <meta name="author" content="{{ config.extra.author }}">

    <!-- Security Headers (X-Frame-Options must be set via HTTP header, not meta tag) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ get_url(path='favicon.svg') }}">
    <link rel="apple-touch-icon" href="{{ get_url(path='favicon.svg') }}">

    <!-- Canonical URL - Prevents duplicate content issues -->
    <link rel="canonical" href="{% block canonical %}{{ current_url | default(value=config.base_url) }}{% endblock %}">

    {% block extra_meta %}{% endblock %}

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{% block og_title %}{{ config.title }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ config.description }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{{ current_url | default(value=config.base_url) }}">
    <meta property="og:image" content="{% block og_image %}{{ config.base_url }}/images/og-image.svg{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{% block og_image_alt %}{{ config.title }} - Exploring spirituality, Bazi, and Tarot{% endblock %}">
    <meta property="og:site_name" content="{{ config.title }}">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ config.title }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ config.description }}{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ config.base_url }}/images/og-image.svg{% endblock %}">
    <meta name="twitter:image:alt" content="{% block twitter_image_alt %}{{ config.title }} - Exploring spirituality, Bazi, and Tarot{% endblock %}">

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">

    <!-- Google Fonts - Inter (body) + Lora (headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- Critical inline CSS to prevent layout shift -->
    <style>
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;line-height:1.6;color:#2d3748;background:#fff}
        .hero{text-align:center;padding:5rem 0 4rem;background:linear-gradient(135deg,#805ad5 0%,#6b46c1 100%);color:#fff;margin-bottom:3rem}
        .container{max-width:1200px;margin:0 auto;padding:0 1rem}
        .recent-posts{padding:4rem 0;min-height:600px}
    </style>

    <!-- Main Stylesheet - Preload for faster loading -->
    <link rel="preload" href="{{ get_url(path='css/tailwind.css') }}" as="style">
    <link rel="stylesheet" href="{{ get_url(path='css/tailwind.css') }}">
    {% block extra_css %}{% endblock %}

    <!-- Search Library - Async loading -->
    <script src="https://unpkg.com/elasticlunr@0.9.5/elasticlunr.min.js" async></script>

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="{{ get_url(path='rss.xml') }}">

    <!-- Google Analytics 4 -->
    {% if config.extra.google_analytics_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.extra.google_analytics_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ config.extra.google_analytics_id }}', {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
        });
    </script>
    {% endif %}
</head>
<body>
    <!-- Reading Progress Bar -->
    <div class="reading-progress" id="readingProgress"></div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-header">
                <input type="text" id="searchInput" placeholder="Search posts..." aria-label="Search">
                <button class="search-close" id="searchClose" aria-label="Close search">&times;</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Navigation -->
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <a href="{{ config.base_url }}" class="site-logo">{{ config.title }}</a>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                </button>

                <ul class="nav-menu" id="navMenu">
                    <li><a href="{{ get_url(path='@/blog/_index.md') }}">Blog</a></li>
                    <li><a href="{{ get_url(path='@/about.md') }}">About</a></li>
                    <li><a href="{{ get_url(path='@/services.md') }}">Services</a></li>
                    <li><a href="{{ get_url(path='@/contact.md') }}">Contact</a></li>
                    <li>
                        <button class="search-toggle" id="searchToggle" aria-label="Search">
                            <span class="search-icon">üîç</span>
                        </button>
                    </li>
                    <li>
                        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                            <span class="theme-icon">üåô</span>
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <span class="back-to-top-icon">‚Üë</span>
    </button>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <p>&copy; {{ now() | date(format="%Y") }} {{ config.extra.author }}. All rights reserved.</p>
            <p>Built with <a href="https://www.getzola.org/" target="_blank" rel="noopener">Zola</a></p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Reading Progress Bar - Optimized to prevent forced reflows
        (function() {
            const progressBar = document.getElementById('readingProgress');
            if (progressBar) {
                let ticking = false;
                let height = 0;

                // Calculate height once on load and resize
                function updateHeight() {
                    height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                }
                updateHeight();
                window.addEventListener('resize', updateHeight);

                function updateProgress() {
                    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                    const scrolled = (winScroll / height) * 100;
                    progressBar.style.width = scrolled + '%';
                    ticking = false;
                }

                window.addEventListener('scroll', function() {
                    if (!ticking) {
                        window.requestAnimationFrame(updateProgress);
                        ticking = true;
                    }
                }, { passive: true });
            }
        })();

        // Mobile Menu Toggle
        (function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navMenu = document.getElementById('navMenu');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    navMenu.classList.toggle('active');
                    document.body.classList.toggle('menu-open');
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mobileMenuToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    }
                });

                // Close menu when clicking a link
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenuToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    });
                });
            }
        })();

        // Dark Mode Toggle
        (function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const html = document.documentElement;

            // Check for saved theme preference or default to light mode
            const currentTheme = localStorage.getItem('theme') || 'light';

            // Apply dark class if theme is dark
            if (currentTheme === 'dark') {
                html.classList.add('dark');
            }
            updateThemeIcon(currentTheme);

            themeToggle.addEventListener('click', function() {
                const isDark = html.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';

                // Toggle dark class
                if (newTheme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }

                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            function updateThemeIcon(theme) {
                themeIcon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        })();

        // Search Functionality - Wait for elasticlunr to load
        (function() {
            const searchToggle = document.getElementById('searchToggle');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            let searchIndex = null;

            // Function to initialize search after elasticlunr is loaded
            function initSearch() {
                if (typeof elasticlunr === 'undefined') {
                    // Wait for elasticlunr to load
                    setTimeout(initSearch, 50);
                    return;
                }

                // Load search index from Zola-generated JS file
                const script = document.createElement('script');
                script.src = '{{ get_url(path="search_index.en.js") }}';
                script.onload = function() {
                    if (window.searchIndex) {
                        searchIndex = elasticlunr.Index.load(window.searchIndex);
                    }
                };
                script.onerror = function() {
                    console.error('Failed to load search index');
                };
                document.head.appendChild(script);
            }

            // Start initialization
            initSearch();

            // Open search modal
            searchToggle.addEventListener('click', function() {
                searchModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                searchInput.focus();
            });

            // Close search modal
            searchClose.addEventListener('click', closeSearch);
            searchModal.addEventListener('click', function(e) {
                if (e.target === searchModal) {
                    closeSearch();
                }
            });

            // ESC key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                    closeSearch();
                }
            });

            function closeSearch() {
                searchModal.classList.remove('active');
                document.body.style.overflow = '';
                searchInput.value = '';
                searchResults.innerHTML = '';
            }

            // Search on input
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }

                if (!searchIndex) {
                    searchResults.innerHTML = '<div class="search-no-results">Search index is loading...</div>';
                    return;
                }

                const results = searchIndex.search(query, {
                    fields: {
                        title: {boost: 2},
                        body: {boost: 1}
                    },
                    expand: true
                });

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-no-results">No results found for "' + query + '"</div>';
                    return;
                }

                let html = '';
                results.slice(0, 10).forEach(result => {
                    // Get the document from the index using the ref
                    const doc = searchIndex.documentStore.getDoc(result.ref);
                    const excerpt = doc.body ? doc.body.substring(0, 150) + '...' : '';
                    // Extract relative URL from absolute URL (works for both dev and production)
                    const url = new URL(doc.id);
                    const relativeUrl = url.pathname;
                    html += `
                        <div class="search-result-item">
                            <h3><a href="${relativeUrl}">${doc.title}</a></h3>
                            <p class="search-result-excerpt">${excerpt}</p>
                        </div>
                    `;
                });
                searchResults.innerHTML = html;
            });
        })();

        // Image Lazy Loading - Add loading="lazy" to all images
        (function() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                if (!img.hasAttribute('loading')) {
                    img.setAttribute('loading', 'lazy');
                }
                if (!img.hasAttribute('decoding')) {
                    img.setAttribute('decoding', 'async');
                }
            });
        })();

        // Keyboard Shortcuts
        (function() {
            // Listen for keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ignore if user is typing in an input
                if (e.target.matches('input, textarea')) return;

                // / key - Open search
                if (e.key === '/' || (e.shiftKey && e.key === '/')) {
                    e.preventDefault();
                    const searchToggle = document.getElementById('searchToggle');
                    if (searchToggle) {
                        searchToggle.click();
                    }
                }

                // ? key - Show keyboard shortcuts help
                if (e.shiftKey && e.key === '?') {
                    e.preventDefault();
                    showKeyboardHelp();
                }
            });

            // Show keyboard shortcuts help modal
            function showKeyboardHelp() {
                const modal = document.getElementById('keyboardHelpModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    // Create modal if it doesn't exist
                    createKeyboardHelpModal();
                }
            }

            function createKeyboardHelpModal() {
                const modal = document.createElement('div');
                modal.id = 'keyboardHelpModal';
                modal.className = 'keyboard-help-modal';
                modal.innerHTML = `
                    <div class="keyboard-help-content">
                        <div class="keyboard-help-header">
                            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                            <button class="keyboard-help-close" id="keyboardHelpClose" aria-label="Close">&times;</button>
                        </div>
                        <div class="keyboard-help-body">
                            <div class="keyboard-shortcut">
                                <kbd>/</kbd>
                                <span>Open search</span>
                            </div>
                            <div class="keyboard-shortcut">
                                <kbd>Esc</kbd>
                                <span>Close modals</span>
                            </div>
                            <div class="keyboard-shortcut">
                                <kbd>?</kbd>
                                <span>Show this help</span>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close modal handlers
                const closeBtn = modal.querySelector('#keyboardHelpClose');
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });

                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        })();

        // Enhanced Analytics Event Tracking
        (function() {
            // Track outbound link clicks
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link && link.href) {
                    const url = new URL(link.href, window.location.href);
                    // Check if it's an outbound link
                    if (url.hostname !== window.location.hostname && url.protocol.startsWith('http')) {
                        // Track with GA4 if available
                        if (typeof gtag === 'function') {
                            gtag('event', 'click', {
                                'event_category': 'outbound',
                                'event_label': url.href,
                                'transport_type': 'beacon'
                            });
                        }
                    }
                }
            });

            // Track search usage
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (this.value.length >= 3 && typeof gtag === 'function') {
                            gtag('event', 'search', {
                                'search_term': this.value
                            });
                        }
                    }, 1000); // Wait 1 second after typing stops
                });
            }

            // Track social share button clicks
            document.addEventListener('click', function(e) {
                const shareBtn = e.target.closest('[data-share]');
                if (shareBtn && typeof gtag === 'function') {
                    const platform = shareBtn.getAttribute('data-share');
                    gtag('event', 'share', {
                        'method': platform,
                        'content_type': 'article',
                        'item_id': window.location.pathname
                    });
                }
            });
        })();

        // Back to Top Button
        (function() {
            const backToTopButton = document.getElementById('backToTop');
            let isVisible = false;

            function toggleBackToTop() {
                const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                const shouldShow = scrollPosition > 300;

                if (shouldShow && !isVisible) {
                    backToTopButton.classList.add('visible');
                    isVisible = true;
                } else if (!shouldShow && isVisible) {
                    backToTopButton.classList.remove('visible');
                    isVisible = false;
                }
            }

            // Throttle scroll events
            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        toggleBackToTop();
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });

            // Smooth scroll to top
            backToTopButton.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        })();

        // Copy Code Button
        (function() {
            const codeBlocks = document.querySelectorAll('pre');

            codeBlocks.forEach((pre) => {
                // Create wrapper for positioning
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);

                // Create copy button
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-code-btn';
                copyButton.innerHTML = '<span class="copy-icon">üìã</span><span class="copy-text">Copy</span>';
                copyButton.setAttribute('aria-label', 'Copy code to clipboard');

                wrapper.appendChild(copyButton);

                // Copy functionality
                copyButton.addEventListener('click', async function() {
                    const code = pre.querySelector('code') || pre;
                    const text = code.textContent;

                    try {
                        await navigator.clipboard.writeText(text);

                        // Success feedback
                        copyButton.innerHTML = '<span class="copy-icon">‚úì</span><span class="copy-text">Copied!</span>';
                        copyButton.classList.add('copied');

                        // Track copy event
                        if (typeof gtag === 'function') {
                            gtag('event', 'copy_code', {
                                'event_category': 'engagement',
                                'event_label': window.location.pathname
                            });
                        }

                        setTimeout(() => {
                            copyButton.innerHTML = '<span class="copy-icon">üìã</span><span class="copy-text">Copy</span>';
                            copyButton.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        // Fallback for older browsers
                        copyButton.innerHTML = '<span class="copy-icon">‚úó</span><span class="copy-text">Failed</span>';
                        setTimeout(() => {
                            copyButton.innerHTML = '<span class="copy-icon">üìã</span><span class="copy-text">Copy</span>';
                        }, 2000);
                    }
                });
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
