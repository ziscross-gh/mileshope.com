<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.title }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ config.description }}{% endblock %}">

    <!-- SEO Meta Tags -->
    <meta name="author" content="{{ config.extra.author }}">
    {% block extra_meta %}{% endblock %}

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{% block og_title %}{{ config.title }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ config.description }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{{ current_url | default(value=config.base_url) }}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ config.title }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ config.description }}{% endblock %}">

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://unpkg.com">

    <!-- Stylesheets - Non-blocking load -->
    <link rel="preload" href="{{ get_url(path='css/tailwind.css') }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ get_url(path='css/tailwind.css') }}"></noscript>
    {% block extra_css %}{% endblock %}

    <!-- Search Library - Deferred -->
    <script src="https://unpkg.com/elasticlunr@0.9.5/elasticlunr.min.js" defer></script>

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="{{ get_url(path='rss.xml') }}">
</head>
<body>
    <!-- Reading Progress Bar -->
    <div class="reading-progress" id="readingProgress"></div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-header">
                <input type="text" id="searchInput" placeholder="Search posts..." aria-label="Search">
                <button class="search-close" id="searchClose" aria-label="Close search">&times;</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Navigation -->
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <a href="{{ config.base_url }}" class="site-logo">{{ config.title }}</a>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                </button>

                <ul class="nav-menu" id="navMenu">
                    <li><a href="{{ get_url(path='@/blog/_index.md') }}">Blog</a></li>
                    <li><a href="{{ get_url(path='@/about.md') }}">About</a></li>
                    <li><a href="{{ get_url(path='@/services.md') }}">Services</a></li>
                    <li>
                        <button class="search-toggle" id="searchToggle" aria-label="Search">
                            <span class="search-icon">üîç</span>
                        </button>
                    </li>
                    <li>
                        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                            <span class="theme-icon">üåô</span>
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <p>&copy; {{ now() | date(format="%Y") }} {{ config.extra.author }}. All rights reserved.</p>
            <p>Built with <a href="https://www.getzola.org/" target="_blank" rel="noopener">Zola</a></p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Reading Progress Bar
        (function() {
            const progressBar = document.getElementById('readingProgress');
            if (progressBar) {
                window.addEventListener('scroll', function() {
                    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                    const scrolled = (winScroll / height) * 100;
                    progressBar.style.width = scrolled + '%';
                });
            }
        })();

        // Mobile Menu Toggle
        (function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navMenu = document.getElementById('navMenu');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    navMenu.classList.toggle('active');
                    document.body.classList.toggle('menu-open');
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mobileMenuToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    }
                });

                // Close menu when clicking a link
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenuToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    });
                });
            }
        })();

        // Dark Mode Toggle
        (function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const html = document.documentElement;

            // Check for saved theme preference or default to light mode
            const currentTheme = localStorage.getItem('theme') || 'light';

            // Apply dark class if theme is dark
            if (currentTheme === 'dark') {
                html.classList.add('dark');
            }
            updateThemeIcon(currentTheme);

            themeToggle.addEventListener('click', function() {
                const isDark = html.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';

                // Toggle dark class
                if (newTheme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }

                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            function updateThemeIcon(theme) {
                themeIcon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        })();

        // Search Functionality
        (function() {
            const searchToggle = document.getElementById('searchToggle');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            let searchIndex = null;

            // Load search index from Zola-generated JS file
            const script = document.createElement('script');
            script.src = '{{ get_url(path="search_index.en.js") }}';
            script.onload = function() {
                if (window.searchIndex) {
                    searchIndex = elasticlunr.Index.load(window.searchIndex);
                }
            };
            script.onerror = function() {
                console.error('Failed to load search index');
            };
            document.head.appendChild(script);

            // Open search modal
            searchToggle.addEventListener('click', function() {
                searchModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                searchInput.focus();
            });

            // Close search modal
            searchClose.addEventListener('click', closeSearch);
            searchModal.addEventListener('click', function(e) {
                if (e.target === searchModal) {
                    closeSearch();
                }
            });

            // ESC key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                    closeSearch();
                }
            });

            function closeSearch() {
                searchModal.classList.remove('active');
                document.body.style.overflow = '';
                searchInput.value = '';
                searchResults.innerHTML = '';
            }

            // Search on input
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }

                if (!searchIndex) {
                    searchResults.innerHTML = '<div class="search-no-results">Search index is loading...</div>';
                    return;
                }

                const results = searchIndex.search(query, {
                    fields: {
                        title: {boost: 2},
                        body: {boost: 1}
                    },
                    expand: true
                });

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-no-results">No results found for "' + query + '"</div>';
                    return;
                }

                let html = '';
                results.slice(0, 10).forEach(result => {
                    // Get the document from the index using the ref
                    const doc = searchIndex.documentStore.getDoc(result.ref);
                    const excerpt = doc.body ? doc.body.substring(0, 150) + '...' : '';
                    // Extract relative URL from absolute URL (works for both dev and production)
                    const url = new URL(doc.id);
                    const relativeUrl = url.pathname;
                    html += `
                        <div class="search-result-item">
                            <h3><a href="${relativeUrl}">${doc.title}</a></h3>
                            <p class="search-result-excerpt">${excerpt}</p>
                        </div>
                    `;
                });
                searchResults.innerHTML = html;
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
