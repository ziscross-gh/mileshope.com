{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock %}
{% block description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}
{% block canonical %}{{ page.permalink }}{% endblock %}

{% block og_title %}{{ page.title }} | {{ config.title }}{% endblock %}
{% block og_description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}
{% block og_type %}article{% endblock %}
{% if page.extra.featured_image %}
{% block og_image %}{{ config.base_url }}{{ page.extra.featured_image }}{% endblock %}
{% block og_image_alt %}{{ page.extra.featured_image_alt | default(value=page.title) }}{% endblock %}
{% endif %}

{% block twitter_title %}{{ page.title }}{% endblock %}
{% block twitter_description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}
{% if page.extra.featured_image %}
{% block twitter_image %}{{ config.base_url }}{{ page.extra.featured_image }}{% endblock %}
{% block twitter_image_alt %}{{ page.extra.featured_image_alt | default(value=page.title) }}{% endblock %}
{% endif %}

{% block extra_meta %}
<!-- Enhanced Open Graph for Articles -->
{% if page.date %}
<meta property="article:published_time" content="{{ page.date }}">
{% if page.updated %}
<meta property="article:modified_time" content="{{ page.updated }}">
{% endif %}
<meta property="article:author" content="{{ config.extra.author }}">
{% if page.taxonomies.categories %}
{% for category in page.taxonomies.categories %}
<meta property="article:section" content="{{ category }}">
{% endfor %}
{% endif %}
{% if page.taxonomies.tags %}
{% for tag in page.taxonomies.tags %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}
{% endif %}
{% if page.reading_time %}
<meta name="twitter:label1" content="Reading time">
<meta name="twitter:data1" content="{{ page.reading_time }} min read">
{% endif %}
{% if page.word_count %}
<meta name="twitter:label2" content="Word count">
<meta name="twitter:data2" content="{{ page.word_count }} words">
{% endif %}
{% endif %}


<!-- JSON-LD Structured Data for Person (About page) -->
{% if page.title == "About" %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "{{ config.extra.author }}",
  "url": "{{ page.permalink }}",
  "description": "{{ page.description }}",
  "knowsAbout": ["Bazi", "Four Pillars of Destiny", "Tarot", "Chinese Astrology", "Divination", "Spirituality"],
  "hasOccupation": {
    "@type": "Occupation",
    "name": "Spiritual Practitioner & Consultant",
    "description": "Bazi and Tarot reader providing consultations and insights"
  }
}
</script>
{% endif %}

<!-- JSON-LD Structured Data for Articles -->
{% if page.date %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ page.title }}",
  "description": "{{ page.description | default(value=page.summary) | default(value='') }}",
  "datePublished": "{{ page.date }}",
  "dateModified": "{{ page.updated | default(value=page.date) }}",
  "author": {
    "@type": "Person",
    "name": "{{ config.extra.author }}",
    "url": "{{ config.base_url }}/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ config.title }}",
    "url": "{{ config.base_url }}"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ page.permalink }}"
  },
  "url": "{{ page.permalink }}",
  {% if page.taxonomies.categories %}
  "articleSection": "{{ page.taxonomies.categories | first }}",
  {% endif %}
  {% if page.taxonomies.tags %}
  "keywords": [
    {% for tag in page.taxonomies.tags %}"{{ tag }}"{% if not loop.last %}, {% endif %}{% endfor %}
  ],
  {% endif %}
  "inLanguage": "en-US"
}
</script>

<!-- Breadcrumb Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ config.base_url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "{{ config.base_url }}/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ page.title }}",
      "item": "{{ page.permalink }}"
    }
  ]
}
</script>
{% endif %}
{% endblock %}

{% block content %}
<article class="blog-post">
    <div class="container">
        <!-- Visual Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="{{ config.base_url }}">üè† Home</a>
                </li>
                {% if page.date %}
                <!-- Blog post breadcrumb -->
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item">
                    <a href="{{ get_url(path='@/blog/_index.md') }}">Blog</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item breadcrumb-current" aria-current="page">
                    {{ page.title }}
                </li>
                {% else %}
                <!-- Static page breadcrumb -->
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item breadcrumb-current" aria-current="page">
                    {{ page.title }}
                </li>
                {% endif %}
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header">
            <h1 class="post-title">{{ page.title }}</h1>
            {% if page.date %}
            <div class="post-meta">
                <time datetime="{{ page.date }}">{{ page.date | date(format="%B %d, %Y") }}</time>
                {% if page.reading_time %}
                <span class="reading-time">üìñ {{ page.reading_time }} min read</span>
                {% endif %}
                {% if page.word_count %}
                <span class="word-count">{{ page.word_count }} words</span>
                {% endif %}
                <button class="reading-list-btn" id="readingListBtn"
                        data-title="{{ page.title }}"
                        data-url="{{ page.permalink }}"
                        data-reading-time="{{ page.reading_time }}"
                        aria-label="Add to reading list">
                    <span class="bookmark-icon">üîñ</span>
                    <span class="bookmark-text">Save</span>
                </button>
            </div>
            {% endif %}
            {% if page.taxonomies.categories %}
            <div class="post-categories">
                {% for category in page.taxonomies.categories %}
                <a href="{{ get_taxonomy_url(kind='categories', name=category) }}" class="category">{{ category }}</a>
                {% endfor %}
            </div>
            {% endif %}
            {% if page.taxonomies.tags %}
            <div class="post-tags">
                {% for tag in page.taxonomies.tags %}
                <a href="{{ get_taxonomy_url(kind='tags', name=tag) }}" class="tag">{{ tag }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <!-- Featured Image -->
        {% if page.extra.featured_image %}
        <div class="featured-image">
            <img src="{{ page.extra.featured_image }}" alt="{{ page.extra.featured_image_alt | default(value=page.title) }}" loading="eager" decoding="async">
        </div>
        {% endif %}

        <!-- Table of Contents (for long posts) -->
        {% if page.toc and page.toc | length > 0 %}
        <aside class="table-of-contents">
            <div class="toc-header">
                <h3>üìë Table of Contents</h3>
                <button class="toc-toggle" id="tocToggle" aria-label="Toggle table of contents">
                    <span class="toc-toggle-icon">‚àí</span>
                </button>
            </div>
            <nav class="toc-nav" id="tocNav">
                <ul>
                {% for h1 in page.toc %}
                    <li>
                        <a href="{{ h1.permalink | safe }}">{{ h1.title }}</a>
                        {% if h1.children %}
                        <ul>
                        {% for h2 in h1.children %}
                            <li><a href="{{ h2.permalink | safe }}">{{ h2.title }}</a></li>
                        {% endfor %}
                        </ul>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            </nav>
        </aside>
        {% endif %}

        <!-- Reading Progress Tracker -->
        {% if page.date and page.reading_time %}
        <div class="reading-progress-tracker" id="readingTracker">
            <span class="reading-tracker-icon">üìñ</span>
            <span class="reading-tracker-text" id="trackerText">{{ page.reading_time }} min left</span>
        </div>
        {% endif %}

        <!-- Post Content -->
        <div class="post-content">
            {{ page.content | safe }}
        </div>

        <!-- Author Bio -->
        {% if page.date %}
        <aside class="author-bio">
            <div class="author-bio-content">
                <div class="author-avatar">
                    <span class="avatar-placeholder">H</span>
                </div>
                <div class="author-info">
                    <h3 class="author-name">{{ config.extra.author }}</h3>
                    <p class="author-description">
                        Practitioner and student of Bazi (Chinese astrology) and Tarot.
                        Exploring the intersection of ancient wisdom and modern life.
                        Sharing insights on spirituality, divination, and personal growth.
                    </p>
                    <a href="{{ get_url(path='@/about.md') }}" class="author-link">More about me ‚Üí</a>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- Related Posts -->
        {% if page.date and page.taxonomies.tags %}
        {% set_global related_posts = [] %}
        {% set current_tags = page.taxonomies.tags %}
        {% set blog_section = get_section(path="blog/_index.md") %}

        {% for post in blog_section.pages %}
            {% if post.permalink != page.permalink and post.taxonomies.tags %}
                {% set_global match_count = 0 %}
                {% for tag in post.taxonomies.tags %}
                    {% if tag in current_tags %}
                        {% set_global match_count = match_count + 1 %}
                    {% endif %}
                {% endfor %}
                {% if match_count > 0 %}
                    {% set_global related_posts = related_posts | concat(with=[post]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if related_posts | length > 0 %}
        <aside class="related-posts">
            <h2>üìö Related Posts</h2>
            <div class="related-posts-grid">
                {% for post in related_posts | slice(end=3) %}
                <article class="related-post-card">
                    <h3><a href="{{ post.permalink }}">{{ post.title }}</a></h3>
                    {% if post.description %}
                    <p class="related-post-excerpt">{{ post.description | truncate(length=120) }}</p>
                    {% endif %}
                    <div class="related-post-meta">
                        {% if post.reading_time %}
                        <span class="reading-time">{{ post.reading_time }} min read</span>
                        {% endif %}
                        {% if post.taxonomies.categories %}
                        <span class="category">{{ post.taxonomies.categories | first }}</span>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
        </aside>
        {% endif %}
        {% endif %}

        <!-- Post Footer -->
        <footer class="post-footer">
            <!-- Post Reactions -->
            {% if page.date %}
            <div class="post-reactions" id="postReactions" data-url="{{ page.permalink }}">
                <h3>What did you think?</h3>
                <div class="reactions-container">
                    <button class="reaction-btn" data-reaction="helpful" aria-label="Helpful">
                        <span class="reaction-emoji">üëç</span>
                        <span class="reaction-label">Helpful</span>
                        <span class="reaction-count">0</span>
                    </button>
                    <button class="reaction-btn" data-reaction="insightful" aria-label="Insightful">
                        <span class="reaction-emoji">‚ú®</span>
                        <span class="reaction-label">Insightful</span>
                        <span class="reaction-count">0</span>
                    </button>
                    <button class="reaction-btn" data-reaction="love" aria-label="Love it">
                        <span class="reaction-emoji">‚ù§Ô∏è</span>
                        <span class="reaction-label">Love it</span>
                        <span class="reaction-count">0</span>
                    </button>
                    <button class="reaction-btn" data-reaction="mindblown" aria-label="Mind blown">
                        <span class="reaction-emoji">ü§Ø</span>
                        <span class="reaction-label">Mind blown</span>
                        <span class="reaction-count">0</span>
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Social Sharing -->
            <div class="share-buttons">
                <h3>Share this post</h3>
                <div class="share-btn-container">
                    <a href="https://twitter.com/intent/tweet?text={{ page.title }}&url={{ page.permalink }}" target="_blank" rel="noopener" class="share-btn twitter">
                        <span>üê¶</span> Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ page.permalink }}" target="_blank" rel="noopener" class="share-btn facebook">
                        <span>üìò</span> Facebook
                    </a>
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ page.permalink }}&title={{ page.title }}" target="_blank" rel="noopener" class="share-btn linkedin">
                        <span>üíº</span> LinkedIn
                    </a>
                    <button class="share-btn copy" id="copyLinkBtn" data-url="{{ page.permalink }}">
                        <span>üîó</span> <span class="copy-text">Copy Link</span>
                    </button>
                </div>
            </div>

            <!-- Navigation to previous/next posts -->
            {% if page.earlier or page.later %}
            <nav class="post-navigation">
                {% if page.earlier %}
                <a href="{{ page.earlier.permalink }}" class="nav-previous">
                    <span class="nav-label">&larr; Previous</span>
                    <span class="nav-title">{{ page.earlier.title }}</span>
                </a>
                {% endif %}
                {% if page.later %}
                <a href="{{ page.later.permalink }}" class="nav-next">
                    <span class="nav-label">Next &rarr;</span>
                    <span class="nav-title">{{ page.later.title }}</span>
                </a>
                {% endif %}
            </nav>
            {% endif %}
        </footer>
    </div>
</article>
{% endblock %}

{% block extra_js %}
<script>
// Copy Link Functionality
(function() {
    const copyBtn = document.getElementById('copyLinkBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            const copyText = this.querySelector('.copy-text');

            navigator.clipboard.writeText(url).then(() => {
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                this.classList.add('copied');

                setTimeout(() => {
                    copyText.textContent = originalText;
                    this.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                copyText.textContent = 'Failed';
                setTimeout(() => {
                    copyText.textContent = 'Copy Link';
                }, 2000);
            });
        });
    }
})();

// Table of Contents Toggle & Active Highlighting
(function() {
    const tocToggle = document.getElementById('tocToggle');
    const tocNav = document.getElementById('tocNav');

    if (tocToggle && tocNav) {
        tocToggle.addEventListener('click', function() {
            const isCollapsed = tocNav.classList.toggle('collapsed');
            const icon = this.querySelector('.toc-toggle-icon');
            icon.textContent = isCollapsed ? '+' : '‚àí';
        });

        // Smooth scroll for TOC links
        const tocLinks = tocNav.querySelectorAll('a');
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);

                if (targetElement) {
                    const offset = 80; // Account for fixed header
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Active TOC Highlighting on Scroll
        const headings = document.querySelectorAll('.post-content h1[id], .post-content h2[id], .post-content h3[id]');

        if (headings.length > 0) {
            let ticking = false;

            function updateActiveTocLink() {
                const scrollPosition = window.scrollY + 100; // Offset for header
                let currentHeading = null;

                // Find the current heading based on scroll position
                headings.forEach(heading => {
                    const headingTop = heading.offsetTop;
                    if (scrollPosition >= headingTop) {
                        currentHeading = heading;
                    }
                });

                // Update active state in TOC
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    if (currentHeading && link.getAttribute('href') === '#' + currentHeading.id) {
                        link.classList.add('active');
                    }
                });

                ticking = false;
            }

            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(updateActiveTocLink);
                    ticking = true;
                }
            }, { passive: true });

            // Initial highlight
            updateActiveTocLink();
        }
    }
})();

// Copy Code Buttons
(function() {
    const codeBlocks = document.querySelectorAll('pre code');

    codeBlocks.forEach((codeBlock) => {
        const pre = codeBlock.parentElement;

        // Create wrapper div
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-code-btn';
        copyButton.setAttribute('aria-label', 'Copy code to clipboard');
        copyButton.innerHTML = '<span class="copy-code-text">Copy</span>';

        wrapper.appendChild(copyButton);

        // Copy functionality
        copyButton.addEventListener('click', async function() {
            const code = codeBlock.textContent;
            const copyText = this.querySelector('.copy-code-text');

            try {
                await navigator.clipboard.writeText(code);
                copyText.textContent = 'Copied!';
                this.classList.add('copied');

                setTimeout(() => {
                    copyText.textContent = 'Copy';
                    this.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
                copyText.textContent = 'Failed';
                setTimeout(() => {
                    copyText.textContent = 'Copy';
                }, 2000);
            }
        });
    });
})();

// Smooth Scrolling for All Internal Links
(function() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href === '#') return; // Skip empty anchors

            const targetElement = document.querySelector(href);
            if (targetElement) {
                e.preventDefault();
                const offset = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });
})();

// Reading Progress Tracker (Time Remaining)
(function() {
    const tracker = document.getElementById('readingTracker');
    const trackerText = document.getElementById('trackerText');

    if (tracker && trackerText) {
        const postContent = document.querySelector('.post-content');
        if (!postContent) return;

        // Extract reading time from initial text (e.g., "5 min left")
        const initialText = trackerText.textContent;
        const totalMinutes = parseInt(initialText.match(/\d+/)?.[0] || 0);

        if (totalMinutes === 0) return;

        function updateReadingProgress() {
            const contentHeight = postContent.offsetHeight;
            const contentTop = postContent.offsetTop;
            const scrolled = window.pageYOffset + window.innerHeight;
            const progress = Math.min(Math.max((scrolled - contentTop) / contentHeight, 0), 1);

            const minutesRemaining = Math.ceil(totalMinutes * (1 - progress));

            if (minutesRemaining <= 0) {
                trackerText.textContent = 'Finished!';
                setTimeout(() => {
                    tracker.classList.add('fade-out');
                }, 1000);
            } else if (minutesRemaining === 1) {
                trackerText.textContent = '1 min left';
            } else {
                trackerText.textContent = minutesRemaining + ' min left';
            }

            // Show tracker after scrolling a bit
            if (progress > 0.05) {
                tracker.classList.add('visible');
            } else {
                tracker.classList.remove('visible');
            }
        }

        // Throttled scroll listener
        let ticking = false;
        window.addEventListener('scroll', function() {
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    updateReadingProgress();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });

        // Initial check
        updateReadingProgress();
    }
})();

// Reading List / Bookmarks Feature
(function() {
    const readingListBtn = document.getElementById('readingListBtn');

    if (!readingListBtn) return;

    const postData = {
        title: readingListBtn.getAttribute('data-title'),
        url: readingListBtn.getAttribute('data-url'),
        readingTime: readingListBtn.getAttribute('data-reading-time'),
        savedAt: new Date().toISOString()
    };

    // Get reading list from localStorage
    function getReadingList() {
        const list = localStorage.getItem('readingList');
        return list ? JSON.parse(list) : [];
    }

    // Save reading list to localStorage
    function saveReadingList(list) {
        localStorage.setItem('readingList', JSON.stringify(list));
    }

    // Check if current post is in reading list
    function isInReadingList() {
        const list = getReadingList();
        return list.some(item => item.url === postData.url);
    }

    // Update button state
    function updateButtonState() {
        const isSaved = isInReadingList();
        const icon = readingListBtn.querySelector('.bookmark-icon');
        const text = readingListBtn.querySelector('.bookmark-text');

        if (isSaved) {
            icon.textContent = '‚úì';
            text.textContent = 'Saved';
            readingListBtn.classList.add('saved');
            readingListBtn.setAttribute('aria-label', 'Remove from reading list');
        } else {
            icon.textContent = 'üîñ';
            text.textContent = 'Save';
            readingListBtn.classList.remove('saved');
            readingListBtn.setAttribute('aria-label', 'Add to reading list');
        }
    }

    // Toggle reading list
    readingListBtn.addEventListener('click', function() {
        const list = getReadingList();
        const index = list.findIndex(item => item.url === postData.url);

        if (index > -1) {
            // Remove from list
            list.splice(index, 1);
            saveReadingList(list);
            updateButtonState();

            // Analytics
            if (typeof gtag === 'function') {
                gtag('event', 'remove_from_reading_list', {
                    'event_category': 'engagement',
                    'event_label': postData.url
                });
            }
        } else {
            // Add to list
            list.unshift(postData);
            saveReadingList(list);
            updateButtonState();

            // Show feedback
            const originalText = this.querySelector('.bookmark-text').textContent;
            this.querySelector('.bookmark-text').textContent = 'Added!';
            setTimeout(() => {
                updateButtonState();
            }, 1500);

            // Analytics
            if (typeof gtag === 'function') {
                gtag('event', 'add_to_reading_list', {
                    'event_category': 'engagement',
                    'event_label': postData.url
                });
            }
        }
    });

    // Initial button state
    updateButtonState();
})();

// Post Reactions Feature
(function() {
    const reactionsContainer = document.getElementById('postReactions');

    if (!reactionsContainer) return;

    const postUrl = reactionsContainer.getAttribute('data-url');
    const reactionButtons = reactionsContainer.querySelectorAll('.reaction-btn');

    // Get reactions from localStorage
    function getReactions() {
        const reactions = localStorage.getItem('postReactions');
        return reactions ? JSON.parse(reactions) : {};
    }

    // Save reactions to localStorage
    function saveReactions(reactions) {
        localStorage.setItem('postReactions', JSON.stringify(reactions));
    }

    // Get user's reactions from localStorage
    function getUserReactions() {
        const userReactions = localStorage.getItem('userReactions');
        return userReactions ? JSON.parse(userReactions) : {};
    }

    // Save user's reactions to localStorage
    function saveUserReactions(userReactions) {
        localStorage.setItem('userReactions', JSON.stringify(userReactions));
    }

    // Update reaction counts and button states
    function updateReactionUI() {
        const reactions = getReactions();
        const userReactions = getUserReactions();
        const postReactions = reactions[postUrl] || {};
        const userPostReactions = userReactions[postUrl] || [];

        reactionButtons.forEach(button => {
            const reactionType = button.getAttribute('data-reaction');
            const countSpan = button.querySelector('.reaction-count');
            const count = postReactions[reactionType] || 0;

            countSpan.textContent = count;

            // Update button state if user has reacted
            if (userPostReactions.includes(reactionType)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // Handle reaction click
    reactionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const reactionType = this.getAttribute('data-reaction');
            const reactions = getReactions();
            const userReactions = getUserReactions();

            // Initialize post reactions if not exists
            if (!reactions[postUrl]) {
                reactions[postUrl] = {};
            }
            if (!userReactions[postUrl]) {
                userReactions[postUrl] = [];
            }

            const postReactions = reactions[postUrl];
            const userPostReactions = userReactions[postUrl];
            const hasReacted = userPostReactions.includes(reactionType);

            if (hasReacted) {
                // Remove reaction
                postReactions[reactionType] = (postReactions[reactionType] || 1) - 1;
                const index = userPostReactions.indexOf(reactionType);
                userPostReactions.splice(index, 1);
                this.classList.remove('active');

                // Animation
                this.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);

                // Analytics
                if (typeof gtag === 'function') {
                    gtag('event', 'remove_reaction', {
                        'event_category': 'engagement',
                        'event_label': reactionType,
                        'value': postUrl
                    });
                }
            } else {
                // Add reaction
                postReactions[reactionType] = (postReactions[reactionType] || 0) + 1;
                userPostReactions.push(reactionType);
                this.classList.add('active');

                // Animation
                this.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);

                // Analytics
                if (typeof gtag === 'function') {
                    gtag('event', 'add_reaction', {
                        'event_category': 'engagement',
                        'event_label': reactionType,
                        'value': postUrl
                    });
                }
            }

            saveReactions(reactions);
            saveUserReactions(userReactions);
            updateReactionUI();
        });
    });

    // Initial UI update
    updateReactionUI();
})();
</script>
{% endblock %}
