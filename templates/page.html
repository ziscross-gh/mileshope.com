{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock %}
{% block description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}
{% block canonical %}{{ page.permalink }}{% endblock %}

{% block og_title %}{{ page.title }} | {{ config.title }}{% endblock %}
{% block og_description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}
{% block og_type %}article{% endblock %}

{% block twitter_title %}{{ page.title }}{% endblock %}
{% block twitter_description %}{{ page.description | default(value=page.summary) | default(value=config.description) }}{% endblock %}

{% block extra_meta %}
<!-- Enhanced Open Graph for Articles -->
{% if page.date %}
<meta property="article:published_time" content="{{ page.date }}">
{% if page.updated %}
<meta property="article:modified_time" content="{{ page.updated }}">
{% endif %}
<meta property="article:author" content="{{ config.extra.author }}">
{% if page.taxonomies.categories %}
{% for category in page.taxonomies.categories %}
<meta property="article:section" content="{{ category }}">
{% endfor %}
{% endif %}
{% if page.taxonomies.tags %}
{% for tag in page.taxonomies.tags %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}
{% endif %}
{% if page.reading_time %}
<meta name="twitter:label1" content="Reading time">
<meta name="twitter:data1" content="{{ page.reading_time }} min read">
{% endif %}
{% if page.word_count %}
<meta name="twitter:label2" content="Word count">
<meta name="twitter:data2" content="{{ page.word_count }} words">
{% endif %}
{% endif %}


<!-- JSON-LD Structured Data for Person (About page) -->
{% if page.title == "About" %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "{{ config.extra.author }}",
  "url": "{{ page.permalink }}",
  "description": "{{ page.description }}",
  "knowsAbout": ["Bazi", "Four Pillars of Destiny", "Tarot", "Chinese Astrology", "Divination", "Spirituality"],
  "hasOccupation": {
    "@type": "Occupation",
    "name": "Spiritual Practitioner & Consultant",
    "description": "Bazi and Tarot reader providing consultations and insights"
  }
}
</script>
{% endif %}

<!-- JSON-LD Structured Data for Articles -->
{% if page.date %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ page.title }}",
  "description": "{{ page.description | default(value=page.summary) | default(value='') }}",
  "datePublished": "{{ page.date }}",
  "dateModified": "{{ page.updated | default(value=page.date) }}",
  "author": {
    "@type": "Person",
    "name": "{{ config.extra.author }}",
    "url": "{{ config.base_url }}/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ config.title }}",
    "url": "{{ config.base_url }}"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ page.permalink }}"
  },
  "url": "{{ page.permalink }}",
  {% if page.taxonomies.categories %}
  "articleSection": "{{ page.taxonomies.categories | first }}",
  {% endif %}
  {% if page.taxonomies.tags %}
  "keywords": [
    {% for tag in page.taxonomies.tags %}"{{ tag }}"{% if not loop.last %}, {% endif %}{% endfor %}
  ],
  {% endif %}
  "inLanguage": "en-US"
}
</script>

<!-- Breadcrumb Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ config.base_url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "{{ config.base_url }}/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ page.title }}",
      "item": "{{ page.permalink }}"
    }
  ]
}
</script>
{% endif %}
{% endblock %}

{% block content %}
<article class="blog-post">
    <div class="container">
        <!-- Visual Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="{{ config.base_url }}">üè† Home</a>
                </li>
                {% if page.date %}
                <!-- Blog post breadcrumb -->
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item">
                    <a href="{{ get_url(path='@/blog/_index.md') }}">Blog</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item breadcrumb-current" aria-current="page">
                    {{ page.title }}
                </li>
                {% else %}
                <!-- Static page breadcrumb -->
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item breadcrumb-current" aria-current="page">
                    {{ page.title }}
                </li>
                {% endif %}
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header">
            <h1 class="post-title">{{ page.title }}</h1>
            {% if page.date %}
            <div class="post-meta">
                <time datetime="{{ page.date }}">{{ page.date | date(format="%B %d, %Y") }}</time>
                {% if page.reading_time %}
                <span class="reading-time">üìñ {{ page.reading_time }} min read</span>
                {% endif %}
                {% if page.word_count %}
                <span class="word-count">{{ page.word_count }} words</span>
                {% endif %}
            </div>
            {% endif %}
            {% if page.taxonomies.categories %}
            <div class="post-categories">
                {% for category in page.taxonomies.categories %}
                <a href="{{ get_taxonomy_url(kind='categories', name=category) }}" class="category">{{ category }}</a>
                {% endfor %}
            </div>
            {% endif %}
            {% if page.taxonomies.tags %}
            <div class="post-tags">
                {% for tag in page.taxonomies.tags %}
                <a href="{{ get_taxonomy_url(kind='tags', name=tag) }}" class="tag">{{ tag }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <!-- Table of Contents (for long posts) -->
        {% if page.toc and page.toc | length > 0 %}
        <aside class="table-of-contents">
            <div class="toc-header">
                <h3>üìë Table of Contents</h3>
                <button class="toc-toggle" id="tocToggle" aria-label="Toggle table of contents">
                    <span class="toc-toggle-icon">‚àí</span>
                </button>
            </div>
            <nav class="toc-nav" id="tocNav">
                <ul>
                {% for h1 in page.toc %}
                    <li>
                        <a href="{{ h1.permalink | safe }}">{{ h1.title }}</a>
                        {% if h1.children %}
                        <ul>
                        {% for h2 in h1.children %}
                            <li><a href="{{ h2.permalink | safe }}">{{ h2.title }}</a></li>
                        {% endfor %}
                        </ul>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            </nav>
        </aside>
        {% endif %}

        <!-- Post Content -->
        <div class="post-content">
            {{ page.content | safe }}
        </div>

        <!-- Author Bio -->
        {% if page.date %}
        <aside class="author-bio">
            <div class="author-bio-content">
                <div class="author-avatar">
                    <span class="avatar-placeholder">H</span>
                </div>
                <div class="author-info">
                    <h3 class="author-name">{{ config.extra.author }}</h3>
                    <p class="author-description">
                        Practitioner and student of Bazi (Chinese astrology) and Tarot.
                        Exploring the intersection of ancient wisdom and modern life.
                        Sharing insights on spirituality, divination, and personal growth.
                    </p>
                    <a href="{{ get_url(path='@/about.md') }}" class="author-link">More about me ‚Üí</a>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- Related Posts -->
        {% if page.date and page.taxonomies.tags %}
        {% set_global related_posts = [] %}
        {% set current_tags = page.taxonomies.tags %}
        {% set blog_section = get_section(path="blog/_index.md") %}

        {% for post in blog_section.pages %}
            {% if post.permalink != page.permalink and post.taxonomies.tags %}
                {% set_global match_count = 0 %}
                {% for tag in post.taxonomies.tags %}
                    {% if tag in current_tags %}
                        {% set_global match_count = match_count + 1 %}
                    {% endif %}
                {% endfor %}
                {% if match_count > 0 %}
                    {% set_global related_posts = related_posts | concat(with=[post]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if related_posts | length > 0 %}
        <aside class="related-posts">
            <h2>üìö Related Posts</h2>
            <div class="related-posts-grid">
                {% for post in related_posts | slice(end=3) %}
                <article class="related-post-card">
                    <h3><a href="{{ post.permalink }}">{{ post.title }}</a></h3>
                    {% if post.description %}
                    <p class="related-post-excerpt">{{ post.description | truncate(length=120) }}</p>
                    {% endif %}
                    <div class="related-post-meta">
                        {% if post.reading_time %}
                        <span class="reading-time">{{ post.reading_time }} min read</span>
                        {% endif %}
                        {% if post.taxonomies.categories %}
                        <span class="category">{{ post.taxonomies.categories | first }}</span>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
        </aside>
        {% endif %}
        {% endif %}

        <!-- Post Footer -->
        <footer class="post-footer">
            <!-- Social Sharing -->
            <div class="share-buttons">
                <h3>Share this post</h3>
                <div class="share-btn-container">
                    <a href="https://twitter.com/intent/tweet?text={{ page.title }}&url={{ page.permalink }}" target="_blank" rel="noopener" class="share-btn twitter">
                        <span>üê¶</span> Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ page.permalink }}" target="_blank" rel="noopener" class="share-btn facebook">
                        <span>üìò</span> Facebook
                    </a>
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ page.permalink }}&title={{ page.title }}" target="_blank" rel="noopener" class="share-btn linkedin">
                        <span>üíº</span> LinkedIn
                    </a>
                    <button class="share-btn copy" id="copyLinkBtn" data-url="{{ page.permalink }}">
                        <span>üîó</span> <span class="copy-text">Copy Link</span>
                    </button>
                </div>
            </div>

            <!-- Navigation to previous/next posts -->
            {% if page.earlier or page.later %}
            <nav class="post-navigation">
                {% if page.earlier %}
                <a href="{{ page.earlier.permalink }}" class="nav-previous">
                    <span class="nav-label">&larr; Previous</span>
                    <span class="nav-title">{{ page.earlier.title }}</span>
                </a>
                {% endif %}
                {% if page.later %}
                <a href="{{ page.later.permalink }}" class="nav-next">
                    <span class="nav-label">Next &rarr;</span>
                    <span class="nav-title">{{ page.later.title }}</span>
                </a>
                {% endif %}
            </nav>
            {% endif %}
        </footer>
    </div>
</article>
{% endblock %}

{% block extra_js %}
<script>
// Copy Link Functionality
(function() {
    const copyBtn = document.getElementById('copyLinkBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            const copyText = this.querySelector('.copy-text');

            navigator.clipboard.writeText(url).then(() => {
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                this.classList.add('copied');

                setTimeout(() => {
                    copyText.textContent = originalText;
                    this.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                copyText.textContent = 'Failed';
                setTimeout(() => {
                    copyText.textContent = 'Copy Link';
                }, 2000);
            });
        });
    }
})();

// Table of Contents Toggle & Active Highlighting
(function() {
    const tocToggle = document.getElementById('tocToggle');
    const tocNav = document.getElementById('tocNav');

    if (tocToggle && tocNav) {
        tocToggle.addEventListener('click', function() {
            const isCollapsed = tocNav.classList.toggle('collapsed');
            const icon = this.querySelector('.toc-toggle-icon');
            icon.textContent = isCollapsed ? '+' : '‚àí';
        });

        // Smooth scroll for TOC links
        const tocLinks = tocNav.querySelectorAll('a');
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);

                if (targetElement) {
                    const offset = 80; // Account for fixed header
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Active TOC Highlighting on Scroll
        const headings = document.querySelectorAll('.post-content h1[id], .post-content h2[id], .post-content h3[id]');

        if (headings.length > 0) {
            let ticking = false;

            function updateActiveTocLink() {
                const scrollPosition = window.scrollY + 100; // Offset for header
                let currentHeading = null;

                // Find the current heading based on scroll position
                headings.forEach(heading => {
                    const headingTop = heading.offsetTop;
                    if (scrollPosition >= headingTop) {
                        currentHeading = heading;
                    }
                });

                // Update active state in TOC
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    if (currentHeading && link.getAttribute('href') === '#' + currentHeading.id) {
                        link.classList.add('active');
                    }
                });

                ticking = false;
            }

            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(updateActiveTocLink);
                    ticking = true;
                }
            }, { passive: true });

            // Initial highlight
            updateActiveTocLink();
        }
    }
})();

// Copy Code Buttons
(function() {
    const codeBlocks = document.querySelectorAll('pre code');

    codeBlocks.forEach((codeBlock) => {
        const pre = codeBlock.parentElement;

        // Create wrapper div
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-code-btn';
        copyButton.setAttribute('aria-label', 'Copy code to clipboard');
        copyButton.innerHTML = '<span class="copy-code-text">Copy</span>';

        wrapper.appendChild(copyButton);

        // Copy functionality
        copyButton.addEventListener('click', async function() {
            const code = codeBlock.textContent;
            const copyText = this.querySelector('.copy-code-text');

            try {
                await navigator.clipboard.writeText(code);
                copyText.textContent = 'Copied!';
                this.classList.add('copied');

                setTimeout(() => {
                    copyText.textContent = 'Copy';
                    this.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
                copyText.textContent = 'Failed';
                setTimeout(() => {
                    copyText.textContent = 'Copy';
                }, 2000);
            }
        });
    });
})();

// Smooth Scrolling for All Internal Links
(function() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href === '#') return; // Skip empty anchors

            const targetElement = document.querySelector(href);
            if (targetElement) {
                e.preventDefault();
                const offset = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });
})();
</script>
{% endblock %}
